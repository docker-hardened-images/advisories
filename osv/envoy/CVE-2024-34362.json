{
  "modified": "2024-06-04T19:38:49Z",
  "published": "2024-06-04T19:38:49Z",
  "schema_version": "1.5.0",
  "id": "CVE-2024-34362",
  "aliases": [
    "GHSA-hww5-43gv-35jv"
  ],
  "details": "### Summary\r\nThere is a use-after-free in `HttpConnectionManager` (HCM) with `EnvoyQuicServerStream` that can crash Envoy.\r\n\r\n### Details\r\n`EnvoyQuicServerStream` doesn't run reset callbacks upon incoming `RESET_STREAM` if no `STOP_SENDING` is received before or afterwards.\r\n\r\nIf a client sends a request without `FIN` and then a `RESET_STREAM` frame, `OnStreamReset()` will not call `runResetCallbacks()` because the write side is not closed yet and Envoy is supposed to be able to send any response. Such a stream will not receive any more request payload and thus will hit stream idle timeout in HCM and send a local reply. \r\n\r\nUpon `FIN` being written to the codec, `ConnectionManagerImpl::doEndStream()` will call `resetStream()` on the `EnvoyQuicServerStream` because HCM hasn't received `FIN` yet, nor does it know about the `RESET_STREAM` received on QUIC stream. \r\n\r\nThe `resetStream()` implementation will call `ResetWithError()` to send both `STOP_SENDING` and `RESET_STREAM` because reading has been stopped. `ResetWithError()` also won't call `runResetCallbacks()` because `local_end_stream_` is already `true`.\r\n\r\nAfter this point, the QUIC stream is both read and write closed and thus legitimate to be destroyed from QUICHE's perspective, but `ActiveStream` in HCM is still referencing the QUIC stream as the response encoder.\r\n\r\nAccessing the response encoder after this can lead to a use-after-free, triggering the following crash stack:\r\n\r\n```console\r\nEnvoy::Http::ConnectionManagerImpl::resetAllStreams\r\nEnvoy::Http::ConnectionManagerImpl::doConnectionClose\r\nEnvoy::Http::ConnectionManagerImpl::onEvent\r\nEnvoy::Network::ConnectionImplBase::raiseConnectionEvent\r\nEnvoy::Quic::QuicFilterManagerConnectionImpl::onConnectionCloseEvent\r\nEnvoy::Quic::EnvoyQuicServerSession::OnConnectionClosed\r\nexternal_quiche_quic::QuicConnection::TearDownLocalConnectionState\r\nexternal_quiche_quic::QuicConnection::OnIdleNetworkDetected\r\nexternal_quiche_quic::QuicAlarm::Fire\r\nevent_process_active_single_queue\r\nevent_process_active\r\nevent_base_loop\r\nEnvoy::Server::WorkerImpl::threadRoutine\r\n```\r\n\r\n### PoC\r\nUse a QUIC client to send a request without `FIN` and then a `RESET_STREAM` frame. After receiving the response, close the connection.\r\n\r\n### Impact\r\nAll HTTP/3 downstream users",
  "affected": [
    {
      "package": {
        "ecosystem": "DHI",
        "name": "envoy",
        "purl": "pkg:dhi/envoy"
      },
      "ranges": [
        {
          "type": "SEMVER",
          "events": [
            {
              "introduced": "0"
            },
            {
              "fixed": "1.27.6"
            },
            {
              "introduced": "1.28.0"
            },
            {
              "fixed": "1.28.4"
            },
            {
              "introduced": "1.29.0"
            },
            {
              "fixed": "1.29.5"
            },
            {
              "introduced": "1.30.0"
            },
            {
              "fixed": "1.30.2"
            }
          ]
        }
      ],
      "database_specific": {
        "source_ecosystem": "envoyproxy",
        "source_package": "QUIC"
      }
    }
  ],
  "references": [
    {
      "type": "WEB",
      "url": "https://github.com/envoyproxy/envoy/security/advisories/GHSA-hww5-43gv-35jv"
    }
  ]
}