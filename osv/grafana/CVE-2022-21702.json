{
  "modified": "2022-02-08T15:13:09Z",
  "published": "2022-02-08T15:13:09Z",
  "schema_version": "1.5.0",
  "id": "CVE-2022-21702",
  "aliases": [
    "GHSA-xc3p-28hw-q24g"
  ],
  "details": "Today we are releasing Grafana 8.3.5 and 7.5.15. This patch release includes MEDIUM severity security fix for XSS for Grafana.\r\n\r\nRelease v.8.3.5, only containing security fixes:\r\n\r\n- [Download Grafana 8.3.5](https://grafana.com/grafana/download/8.3.5)\r\n- [Release notes](https://grafana.com/docs/grafana/latest/release-notes/release-notes-8-3-5/)\r\n\r\nRelease v.7.5.15, only containing security fixes:\r\n\r\n- [Download Grafana 7.5.15](https://grafana.com/grafana/download/7.5.15)\r\n- [Release notes](https://grafana.com/docs/grafana/latest/release-notes/release-notes-7-5-15/)\r\n\r\n## XSS ([CVE-2022-21702](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21702))\r\n\r\n### Summary\r\n\r\nOn Jan. 16, an external security researcher, Jasu Viding contacted Grafana to disclose an XSS vulnerability in the way that Grafana handles data sources.\r\n\r\nAn attacker could serve HTML content through the Grafana datasource or plugin proxy and trick a user to visit this HTML page using a specially crafted link and execute a Cross-site Scripting (XSS) attack. The attacker could either compromise an existing datasource for a specific Grafana instance or either set up its own public service and instruct anyone to set it up in their Grafana instance.\r\n\r\nWe believe that this vulnerability is rated at CVSS 6.8 (CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:N/A:N).  \r\n\r\n### Impact\r\n\r\nShould an existing data source connected to Grafana be compromised, it could be used to inappropriately gain access to other data sources connected to the same Grafana org.\r\n\r\n### Affected versions with MEDIUM severity \r\n\r\nTo be impacted, all of the following must be applicable:\r\n\r\n**For data source proxy**:\r\n - A Grafana instance running version v2.0.0-beta1 up to v8.3.4.\r\n - A Grafana HTTP-based datasource configured with Server as Access Mode and a URL set.\r\n - Attacker to be in control of the HTTP server serving the URL of above data source.\r\n - A specially crafted link pointing at http://host/api/datasources/proxy/\"data source id\" and attacker somehow tricks a user of the above Grafana instance to click/visit the link.\r\n - A user that’s already authenticated to above Grafana instance clicks on/visits the specially crafted link sent/provided by the attacker.\r\n\r\n**For plugin proxy**:\r\n- A Grafana instance running version v2.0.0-beta1 up to v8.3.4.\r\n- A Grafana HTTP-based app plugin configured and enabled with a URL set.\r\n- Attacker to be in control of the HTTP server serving the URL of above app.\r\n- A specially crafted link pointing at http://host/api/plugin-proxy/\"plugin id\" and attacker somehow tricks a user of the above Grafana instance to click/visit the link.\r\n- A user that’s already authenticated to above Grafana instance clicks on/visits the specially crafted link sent/provided by the attacker.\r\n\r\n**Backend plugin resource**:\r\n- A Grafana instance running version v7.0.0-beta1 up to v8.3.4.\r\n- Attacker potentially needs to craft a custom plugin to be able to pull this off, but if an attacker can compromise/control the backend service that a backend plugin connects to, it might be possible to serve HTML content via the /api/plugins/\"plugin Id\"/resources* or /api/datasources/\"id\"/resources* routes.\r\n- A specially crafted link pointing at /api/plugins/\"plugin Id\"\u003e/resources* or /api/datasources/\"id\"/resources* and attacker somehow tricks a user of the above Grafana instance to click/visit the link.\r\n- A user that’s already authenticated to above Grafana instance clicks on/visits the specially crafted link sent/provided by the attacker.\r\n\r\n### Root Causes\r\n#### Trigger\r\nReproduced and confirmed via this Golang app:\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"net/http\"\r\n)\r\n\r\nfunc main() {\r\n\thttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\r\n\t\tfmt.Fprintf(w, \"\u003chtml\u003e\u003cbody\u003e\u003cscript\u003ealert('XSS');\u003c/script\u003e\u003c/body\u003e\u003c/html\u003e\")\r\n\t})\r\n\r\n\tlog.Fatal(http.ListenAndServe(\":3011\", nil))\r\n}\r\n```\r\n\r\nA Prometheus datasource is configured in Grafana with URL http://localhost:3011.\r\n\r\nWhen visitining http://localhost:3000/api/datasources/proxy/170 the scripts declared in the HTML page executes. Confirmed in both Chrome and Firefox.\r\n\r\n### Solutions and mitigations\r\n\r\nAll installations between Grafana v2.0.0-beta1 up to v8.3.4 should be upgraded as soon as possible.\r\n\r\n#### Workarounds\r\n\r\nUsing a proxy, set a response header Content Security Policy: sandbox for the following routes:\r\n\r\n`/api/datasources/proxy*`\r\n`/api/plugin-proxy*`\r\n`/api/plugins/\u003cpluginId\u003e/resources*`\r\n`/api/datasources/\u003cid\u003e/resources*`\r\n\r\nAnother possible mitigation is setting the response header Content-Disposition: attachment; “proxy.txt”. Confirmed in both Chrome and Firefox.\r\n\r\n### Timeline and postmortem\r\n\r\nHere is a detailed timeline starting from when we originally learned of the issue. All times in UTC.\r\n\r\n- 2022-01-16 16:19 Issue submitted by Jasu Viding\r\n- 2022-01-17 14:40 CVSS score confirmed 6.8 at maximum and MEDIUM impact\r\n- 2022-01-17 15:15 Vulnerability confirmed reproducible \r\n- 2022-01-17 16:01 Begin mitigation for Grafana Cloud\r\n- 2022-01-18 15:12 Similar report received \r\n- 2022-01-19 09:57 CVE requested \r\n- 2022-01-19 13:21 PR with fix opened\r\n- 2022-01-19 19:53 GitHub issues CVE-2022-21702\r\n- 2022-01-20 12:43 Second similar report received\r\n- 2022-01-21 14:30 Private release planned for 2022-01-25, and public release planned for 2022-02-01\r\n- 2022-01-25 12:00 Private release with patches\r\n- 2022-02-01 12:00 During the public release process, we realized that private 7.x release was incomplete. Abort public release, send second private release to customers using 7.x\r\n- 2022-02-08 13:00 Public release\r\n\r\n### Acknowledgement\r\nWe would like to thank Jasu Viding for responsibly disclosing the vulnerability.\r\n\r\n### Reporting security issues\r\n\r\nIf you think you have found a security vulnerability, please send a report to security@grafana.com. This address can be used for all of Grafana Labs' open source and commercial products (including, but not limited to Grafana, Grafana Cloud, Grafana Enterprise, and grafana.com). We can accept only vulnerability reports at this address. We would prefer that you encrypt your message to us by using our PGP key. The key fingerprint is\r\n\r\nF988 7BEA 027A 049F AE8E 5CAA D125 8932 BE24 C5CA\r\n\r\nThe key is available from keyserver.ubuntu.com.\r\n\r\n### Security announcements\r\n\r\nWe maintain a [security category](https://community.grafana.com/c/support/security-announcements) on our blog, where we will always post a summary, remediation, and mitigation details for any patch containing security fixes.\r\n\r\nYou can also subscribe to our [RSS feed](https://grafana.com/tags/security/index.xml).\r\n\r\n",
  "affected": [
    {
      "package": {
        "ecosystem": "DHI",
        "name": "grafana",
        "purl": "pkg:dhi/grafana"
      },
      "ranges": [
        {
          "type": "SEMVER",
          "events": [
            {
              "introduced": "2.0.0-beta1"
            },
            {
              "fixed": "7.5.15"
            },
            {
              "introduced": "8.0.0"
            },
            {
              "fixed": "8.3.5"
            }
          ]
        }
      ],
      "database_specific": {
        "source_ecosystem": "grafana",
        "source_package": "datasource and plugin proxy"
      }
    }
  ],
  "references": [
    {
      "type": "WEB",
      "url": "https://github.com/grafana/grafana/security/advisories/GHSA-xc3p-28hw-q24g"
    }
  ]
}