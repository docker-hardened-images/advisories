{
  "modified": "2024-12-18T16:12:55Z",
  "published": "2024-12-18T16:12:55Z",
  "schema_version": "1.5.0",
  "id": "CVE-2024-53271",
  "aliases": [
    "GHSA-rmm5-h2wv-mg4f"
  ],
  "details": "### Summary\r\nAfter upgrade envoy-1.29 to envoy-1.31.* started observing increased number of failures on downstream services, failing with parsing errors etc.\r\n\r\n### Details\r\nsetup where issue is reproduceable, however could not find a minimal working environment ALB-\u003eHTTP/1.1-\u003eEnvoyA-\u003eHTTP2-\u003eEnvoyB-\u003eHTTP/1.1-\u003eCustom HTTP/1.1 SRV\r\n\r\nEnvoyB performs queueing with disabled outlier detection through upstream cluster config:\r\n\r\n```\r\n    outlier_detection:\r\n      consecutive_5xx: 0\r\n      enforcing_consecutive_5xx: 0\r\n      consecutive_gateway_failure: 0\r\n      enforcing_consecutive_gateway_failure: 0\r\n      split_external_local_origin_errors: true\r\n      consecutive_local_origin_failure: 0\r\n      enforcing_consecutive_local_origin_failure: 0\r\n      enforcing_local_origin_success_rate: 0\r\n    circuit_breakers:\r\n      thresholds:\r\n      - priority: DEFAULT\r\n        max_connections: 1536\r\n        max_requests: 2048\r\n        max_pending_requests: 2048\r\n        max_retries: 512\r\n      - priority: HIGH\r\n        max_connections: 1536\r\n        max_requests: 2048\r\n        max_pending_requests: 2048\r\n        max_retries: 512\r\n      per_host_thresholds:\r\n      - priority: DEFAULT\r\n        max_connections: 3\r\n      - priority: HIGH\r\n        max_connections: 3\r\n    typed_extension_protocol_options:\r\n      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:\r\n        \"@type\": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions\r\n        common_http_protocol_options:\r\n          idle_timeout: 90s\r\n          max_requests_per_connection: 64\r\n        explicit_http_config:\r\n          http_protocol_options:\r\n            allow_chunked_length: false\r\n            override_stream_error_on_invalid_http_message: false\r\n```\r\n\r\nOriginal hypothesis was that some of requests got entangled, which was confirmed during research. Investigation leads to envoy.reloadable_features.http1_balsa_delay_reset flag which is set to true by default, together with another leading observation that HEAD request could not flow though envoyB always failing through UT/DR (depends on client timeout settings) and parser failure when SRV response is coupled with `102 Processing` here is the log of simple curl request:\r\n\r\n\u003cdetails\u003e\r\n\u003csummary\u003elifecycle of a head request with 102 :\u003c/summary\u003e\r\n```\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][debug][pool] [external/envoy/source/common/conn_pool/conn_pool_base.cc:495] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] client disconnected, failure reason: \"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][debug][client] [external/envoy/source/common/http/codec_client.cc:107] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] disconnect. resetting 0 pending requests\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:469] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] raising connection event 1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][debug][connection] [external/envoy/source/common/tls/ssl_socket.cc:334] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] SSL shutdown: rc=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][debug][connection] [external/envoy/source/common/network/connection_impl.cc:276] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] closing socket: 1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][debug][connection] [external/envoy/source/common/network/connection_impl.cc:150] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] closing data_to_write=0 type=1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][debug][client] [external/envoy/source/common/http/codec_client.cc:171] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] Error dispatching received data: \"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:1486] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] status_code 200\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=Content-Length value=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:838] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] onHeadersCompleteImpl\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=... value=...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=... value=....\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=Content-Type value=application/xml\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=... value=...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=... value=...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=Set-Cookie ...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=Set-Cookie ...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=Set-Cookie ...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key=Set-Cookie ...\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:587] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] message begin\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:645] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] parsing 593 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:168] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read 593 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:132] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl error occurred while read: WANT_READ\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:92] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read returns: -1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:92] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read returns: 593\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:654] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] read ready. dispatch_buffered_data=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.264][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:614] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] socket event: 3\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:695] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] parsed 27 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][debug][pool] [external/envoy/source/common/conn_pool/conn_pool_base.cc:215] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] destroying stream: 0 remaining\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][debug][pool] [external/envoy/source/common/http/http1/conn_pool.cc:53] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] response complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][debug][client] [external/envoy/source/common/http/codec_client.cc:129] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] response complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:1568] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] message complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:942] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] message complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:1568] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] message complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:942] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] message complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:1496] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] Client: onHeadersComplete size=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:1486] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] status_code 102\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:544] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] completed header: key= value=\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:838] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] onHeadersCompleteImpl\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:587] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] message begin\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][http] [external/envoy/source/common/http/http1/codec_impl.cc:645] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] parsing 27 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:168] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read 27 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:132] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl error occurred while read: WANT_READ\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.259][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:92] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read returns: -1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:92] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read returns: 27\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:654] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] read ready. dispatch_buffered_data=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:614] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] socket event: 3\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:168] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read 0 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:132] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl error occurred while read: WANT_READ\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:92] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read returns: -1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:654] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] read ready. dispatch_buffered_data=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:614] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] socket event: 3\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:614] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] socket event: 2\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:168] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read 0 bytes\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:132] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl error occurred while read: WANT_READ\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.258][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:92] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl read returns: -1\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:654] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] read ready. dispatch_buffered_data=0\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/tls/ssl_socket.cc:282] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl write returns: 626\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][debug][client] [external/envoy/source/common/http/codec_client.cc:142] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] encode complete\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:529] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] writing 626 bytes, end_stream false\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][debug][pool] [external/envoy/source/common/conn_pool/conn_pool_base.cc:182] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] creating stream\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][debug][pool] [external/envoy/source/common/conn_pool/conn_pool_base.cc:328] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] attaching to next stream\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][debug][client] [external/envoy/source/common/http/codec_client.cc:88] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] connected\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:469] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] raising connection event 2\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.257][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:614] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] socket event: 3\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.254][60][trace][connection] [external/envoy/source/common/tls/ssl_handshaker.cc:149] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] ssl error occurred while read: WANT_READ\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.254][60][debug][connection] [external/envoy/source/common/network/connection_impl.cc:746] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] connected\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.254][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:737] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] write ready\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.254][60][trace][connection] [external/envoy/source/common/network/connection_impl.cc:614] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] socket event: 2\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.253][60][debug][connection] [external/envoy/source/common/network/connection_impl.cc:1036] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] connection in progress\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.253][60][debug][connection] [external/envoy/source/common/network/connection_impl.cc:1017] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] connecting to 10.104.108.183:50089\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.253][60][debug][client] [external/envoy/source/common/http/codec_client.cc:57] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] connecting\"}}\r\n{\"line\":\"[2024-10-22 16:12:28.253][60][debug][connection] [external/envoy/source/common/network/connection_impl.h:98] [Tags: \\\"ConnectionId\\\":\\\"87\\\"] current connecting state: true\"}}\r\n```\r\n\u003c/details\u003e\r\n\r\nthe theory is that configuration somehow triggers the problem in the parser and make it even worse if response from the server is not \r\n well formatted single response, as a result other components become unreliable, while we would UPE or something similar.\r\n\r\n### PoC\r\nin test environment were able to easily reproduce by submitting `HEAD` requests, and server response as sequence of:\r\n```\r\nHTTP/1.1 102 Processing\\r\\n\r\n\\r\\n\r\nHTTP/1.1 200 Ok \\r\\n\r\n......\r\n```\r\n\r\n25 clients. one instance of envoyB, all requests hitting same SRV instance(process is sequential), Client timeout ~ 150ms, Request Duration ~30ms, Avg Response on client ~ 440ms,,  65% of request failing with DC on envoyA, %50 of requests got to envoyB failing with DR, rest of requests has `200 ok`\r\n\r\nwas not able to reproduce the request entanglement without keep-alive `max_requests_per_connection: 1` or with disabled delayed reset: `envoy.reloadable_features.http1_balsa_delay_reset=false`\r\n\r\n### Impact\r\nHigh, users who are using keep-alive http/1.1 upstream and/or vulnerable upstream server which not strictly posing single well formatted responses\r\n\r\n### Mitigation\r\n* Disable envoy.reloadable_features.http1_balsa_delay_reset\r\n",
  "affected": [
    {
      "package": {
        "ecosystem": "DHI",
        "name": "envoy",
        "purl": "pkg:dhi/envoy"
      },
      "ranges": [
        {
          "type": "SEMVER",
          "events": [
            {
              "introduced": "1.31.0"
            },
            {
              "fixed": "1.31.5"
            },
            {
              "introduced": "1.32.0"
            },
            {
              "fixed": "1.32.3"
            }
          ]
        }
      ],
      "database_specific": {
        "source_ecosystem": "",
        "source_package": "envoy"
      }
    }
  ],
  "references": [
    {
      "type": "WEB",
      "url": "https://github.com/envoyproxy/envoy/security/advisories/GHSA-rmm5-h2wv-mg4f"
    }
  ]
}