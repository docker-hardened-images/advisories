{
  "modified": "2023-07-12T22:32:44Z",
  "published": "2023-07-12T22:32:44Z",
  "schema_version": "1.5.0",
  "id": "CVE-2023-35945",
  "aliases": [
    "GHSA-jfxv-29pc-x22r"
  ],
  "details": "### Summary\r\nEnvoyâ€™s HTTP/2 codec may leak a header map and bookkeeping structures upon receiving `RST_STREAM` immediately followed by the `GOAWAY` frames from an upstream server.\r\n\r\n### Affected Component\r\nHTTP/2 codec\r\n\r\n### Details\r\nIn nghttp2, cleanup of pending requests due to receipt of the `GOAWAY` frame skips de-allocation of the bookkeeping structure and pending compressed header.\r\n\r\nThe error return [code path](https://github.com/nghttp2/nghttp2/blob/e7f59406556c80904b81b593d38508591bb7523a/lib/nghttp2_session.c#L3346) is taken if connection is already marked for not sending more requests due to `GOAWAY` frame. \r\n\r\nThe clean-up code is right after the return statement, causing memory leak.\r\n\r\n### PoC\r\n* From H/2 server accept the connection from Envoy.\r\n* Send `MAX CONCURRENT STREAMS` = 1\r\n* After receiving request\r\n* Send `RST_STREAM` for the request\r\n* Send `GO_AWAY` with max stream is = 0.\r\n\r\nEnvoy needs a steady stream of requests from a client.\r\n\r\nUpon receiving `RST_STREAM` Envoy frees up stream capacity on a connection and submits headers for the next request.\r\nIn the same I/O operation it also processes `GOAWAY` and marks connection to not send any more requests.\r\nWhen processing outbound request queue nghttp2 enters the error handling branch due to connection marked for not sending more requests. In this branch there is no clean-up for the outbound request. \r\n\r\n### Impact\r\nDenial of service through memory exhaustion.\r\n\r\n### Attack vector(s)\r\nSpecifically crafter response from an untrusted upstream service.\r\n\r\n### Mitigation\r\nNone, apart from disabling HTTP/2 protocol for upstream services.\r\n\r\n### Detection\r\nProcess termination due to out of memory conditions. If collection of memory profile is allowed, the profile will show memory consumed from the `submit_headers_shared` function in the `nghttp2_submit.c` file.\r\n\r\n### Credits\r\nYan Avlasov yavlasov@google.com\r\n\r\n\r\n",
  "affected": [
    {
      "package": {
        "ecosystem": "DHI",
        "name": "envoy",
        "purl": "pkg:dhi/envoy"
      },
      "ranges": [
        {
          "type": "SEMVER",
          "events": [
            {
              "introduced": "0"
            },
            {
              "fixed": "1.23.11"
            },
            {
              "introduced": "1.24.0"
            },
            {
              "fixed": "1.24.9"
            },
            {
              "introduced": "1.25.0"
            },
            {
              "fixed": "1.25.8"
            },
            {
              "introduced": "1.26.0"
            },
            {
              "fixed": "1.26.3"
            }
          ]
        }
      ],
      "database_specific": {
        "source_ecosystem": "",
        "source_package": "Envoy"
      }
    }
  ],
  "references": [
    {
      "type": "WEB",
      "url": "https://github.com/envoyproxy/envoy/security/advisories/GHSA-jfxv-29pc-x22r"
    }
  ]
}